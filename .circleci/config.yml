version: 2.1
orbs:
  gcp-cli: circleci/gcp-cli@2.1.0

jobs:
  deploy:
    docker:
      - image: cimg/node:lts
      - image: google/cloud-sdk
    steps:
      - checkout
      - run: npm install
      - run: npm run test
      - run: npm run build
      - run: cd cf-worker && npm install && CF_API_TOKEN=$CLOUDFLARE_API_TOKEN CLOUD_FLARE_EMAIL=harrycol97@gmail.com npx wrangler pages publish ../build --project-name=portfolio --branch=main

  gae_deploy:
    docker:
      - image: google/cloud-sdk:latest
    steps:
      - checkout
      - attach_workspace:
          at: ./
      - gcp-cli/initialize
      - run:
          name: Deploy to Google App Engine
          command: |
            cd server
            gcloud app deploy ./app.yaml --set-env-vars="PORT=8080, SPOTIFY_CLIENT_ID=$SPOTIFY_CLIENT_ID, SPOTIFY_CLIENT_SECRET=$SPOTIFY_CLIENT_SECRET, SPOTIFY_REFRESH_TOKEN=$SPOTIFY_REFRESH_TOKEN, SPOTIFY_REFRESH_TOKEN_URL=$SPOTIFY_REFRESH_TOKEN_URL, SPOTIFY_RECENTLY_PLAYED_URL=$SPOTIFY_RECENTLY_PLAYED_URL"

workflows:
  deploy:
    jobs:
      - deploy:
          context: cf-worker
      - gae_deploy:
          filters:
            branches:
              only:
                - main
